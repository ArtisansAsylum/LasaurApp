<!DOCTYPE html> 
<html> 
<head> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<title>LasaurApp</title> 
<link rel="stylesheet" href="/css/smoothness/jquery-ui-1.8.9.custom.css" type="text/css">	
<link rel="stylesheet" href="/css/jquery.toastmessage.css" type="text/css">	
<link rel="stylesheet" href="/css/style.css" type="text/css"> 
<script src="/js/jquery-1.5.min.js"></script>
<script src="/js/jquery-ui-1.8.9.custom.min.js"></script>
<script src="/js/jquery.form.js"></script>
<script src="/js/jquery.toastmessage.js"></script>
<script src="/js/lasaurCanvasLib.js"></script>
<script src="/js/lasaurGcodeLib.js"></script>
<script src="/js/app.js"></script>


</head>



<body style="min-width:1000px; padding:10px">


<div id="left-panel" style="width:300px; float:left">
	
<div class="ui-corner-all" style="height:300px; background-color:#e4f83b">
	<img src="/img/lasersaur-dino-lasaurapp-190.png" style="padding:10px; padding-left:15px">
	<div id="serial_connection" class="button_row">Connect</div>
	<div id="escape_fire" class="button_row">Force Home</div>
	
	<ul style="clear:both; padding-top:20px">
	<li><a href="#" id="find_home">run homing cycle</a></li>
	<li><a href="#" id="go_home">go home to origin</a></li>
	</ul>
</div>

<div id="log-container" style="margin:5px 0px;">
<a id="log_toggle" href="#">show log</a>
<div id="log_content" class="ui-corner-all" style="margin-top:5px; display:none; overflow:auto; height:300px; border:1px solid #aaaaaa">
	<!-- log -->
</div>
</div>

</div>  <!-- end of left-panel -->


	
<div id="tabs-main" style="width:680px; height:620px; margin-left:310px;overflow:hidden;">
<ul>
	<li><a href="#tab-gcode">Laser Jobs</a></li>
	<li><a href="#tab-mover">Direct Control</a></li>
	<li><a href="#svg-importer">Open SVG</a></li>
</ul>
		
<div id="tab-gcode" style="padding:30px">
	<div style="float:left">	
		<h3>Queue</h3>
		<div id="gcode_queue" class="gcode_programs"></div>
		<h3>Library</h3>
		<div id="library_placeholder">To be replaced by Javascript</div>
		<h3>Calibration</h3>
		<div id="calibration_placeholder">To be replaced by Javascript</div>
	</div>	
	<div id="gcode_widget" class="ui-corner-all" style="padding:20px; background-color:#cccccc; float:right">
		<form id="gcode_form">
			<h3>G-Code</h3>
			<div><textarea id="gcode_program" style="font-size:0.8em; width:300px; height:100px"></textarea></div>
			<h3>Preview</h3>
			<div><canvas id="preview_canvas" width="305px" height="155px"></div>
			<div id="gcode_submit" style="margin-left:0; margin-top:20px">Send to Lasersaur</div>
			<div id="progressbar" style="width:305px; height:20px; margin-top:60px"></div>
		</form>	
	</div>
	<img src="/img/big-arrow.png" style="float:right; margin:110px 40px 110px 20px;"/>
</div>

<div id="tab-mover" style="padding-left:128px; padding-top:60px">
		<div id="lasaur_widget" style="position:relative; width:425px; height:270px;">
			<div id="outer_top" style="position:absolute; left:10px; top:0px; width:405px; height:10px; background-color:#546883;"></div> 
			<div id="outer_left" style="position:absolute; left:0px; top:0px; width:10px; height:270px; background-color:#546883;"></div> 
			<div id="outer_right" style="position:absolute; left:415px; top:0px; width:10px; height:270px; background-color:#546883;"></div> 
			<div id="gantry_top" style="position:absolute; left:10px; top:35px; width:405px; height:10px; background-color:#83BBFF;"></div> 
			<div id="gantry_bottom" style="position:absolute; left:10px; top:260px; width:405px; height:10px; background-color:#83BBFF;"></div> 
			<div id="gantry_left" style="position:absolute; left:22.5px; top:45px; width:10px; height:215px; background-color:#83BBFF;"></div> 
			<div id="gantry_right" style="position:absolute; left:392.5px; top:45px; width:10px; height:215px; background-color:#83BBFF;"></div> 
			<div id="y_cart" style="position:absolute; left:19px; top:68px; width:387px; height:10px; background-color:#650B01;"></div> 
			<div id="x_cart" style="position:absolute; left:54px; top:76.5px; width:12px; height:12px; background-color:#9E4301;"></div> 
			<div id="cutting_area" style="position:absolute; left:60px; top:82.5px; width:305px; height:155px; border:1px solid #888888; opacity:0.3"></div>	
		</div>
		<form>
			<div id="move_type_radio" style="margin:10px; float:left">
				<input type="radio" id="radio_g0" name="radio" checked="checked" /><label for="radio_g0">G0</label>
				<input type="radio" id="radio_g1" name="radio" /><label for="radio_g1">G1</label>
			</div>
		</form>
		<div id="feedrate" style="margin:23px; width:150px; float:left"></div>
		<input id="feedrate_field" type="textfield" value="10000" style="margin:15px; width:50px; float:left"></input>
</div>

<div id="svg-importer" style="padding-left:128px; padding-top:60px">
	<form id="svg_upload_form" action="/svg_upload" method="post" enctype="multipart/form-data">
	<input type="file" name="data">
	<input type="submit" name="submitBtn" value="Upload" />
	<div id="svg_upload_results"></div>
	</form>
</div>

</div> <!--end of tabs -->




<!-- Gcode Library Start -->

<div id="gcode_library" class="gcode_programs">

<a href="#">triangle </a>
<div>
G21
G90
S255
G0X200Y100F20000
G1X230Y100F600
G1X230Y130
G1X200Y100
G0X0Y0F20000
S0
</div>

<a href="#">tangram</a>	
<div>
G21
G90
S255
G0 X60 Y120 F5000
G1 X40 Y100 F600
G0 X20 Y120
G1 X100 Y40
G0 X100 Y80
G1 X60 Y120
G0 X60 Y80
G1 X20 Y40
G0 X20 Y40
G1 X100 Y40
G1 X100 Y120
G1 X20 Y120
G1 X20 Y40
G0 X60 Y80
G1 X80 Y100
G1 X80 Y60
G0 X0 Y0
S0
</div>

<a href="#">curves from arcs</a>
<div>
G21
G90
S255
G00 X 200.0000 Y 79.4444
G02 X 227.7539 Y 101.0366 I 100.3359 J -100.3359 F 3000.0000
G02 X 262.5000 Y 116.9444 I 91.0105 J -152.8855
G02 X 291.2380 Y 123.2143 I 43.5713 J -130.7138
G02 X 326.5625 Y 121.6319 I 12.5189 J -115.6105
G02 X 359.0308 Y 109.9347 I -22.8883 J -114.4413
G02 X 400.0000 Y 79.4444 I -83.4766 J -154.9361
G03 X 440.9693 Y 48.9542 I 124.4458 J 124.4458
G03 X 473.4375 Y 37.2569 I 55.3565 J 102.7440
G03 X 508.7620 Y 35.6745 I 22.8056 J 114.0281
G03 X 537.5000 Y 41.9444 I -14.8333 J 136.9836
G03 X 572.2461 Y 57.8523 I -56.2645 J 168.7934
G03 X 600.0000 Y 79.4444 I -72.5820 J 121.9281
G03 X 621.5921 Y 107.1984 I -100.3359 J 100.3359
G03 X 637.5000 Y 141.9444 I -152.8855 J 91.0105
G03 X 643.7699 Y 170.6824 I -130.7138 J 43.5713
G03 X 642.1875 Y 206.0069 I -115.6105 J 12.5189
G03 X 630.4903 Y 238.4752 I -114.4413 J -22.8883
G03 X 600.0000 Y 279.4444 I -154.9361 J -83.4766
G02 X 569.5098 Y 320.4137 I 124.4458 J 124.4458
G02 X 557.8125 Y 352.8819 I 102.7440 J 55.3565
G02 X 556.2301 Y 388.2064 I 114.0281 J 22.8056
G02 X 562.5000 Y 416.9444 I 136.9837 J -14.8333
G02 X 578.4079 Y 451.6905 I 168.7934 J -56.2645
G02 X 600.0000 Y 479.4444 I 121.9280 J -72.5820
G03 X 596.9191 Y 504.1175 I -100.3359 J 0.0000 F 3000.0000
G03 X 587.5000 Y 529.4444 I -121.9480 J -30.9375
G03 X 576.2660 Y 546.9484 I -87.1425 J -43.5713
G03 X 557.8125 Y 563.8194 I -64.0647 J -51.5458
G03 X 535.7298 Y 574.2049 I -45.7765 J -68.6648
G03 X 500.0000 Y 579.4444 I -35.7297 J -119.2063
G03 X 464.3968 Y 571.6049 I 0.0000 J -84.7661
G03 X 426.5625 Y 548.1944 I 77.6393 J -167.7525
G03 X 393.0447 Y 516.5795 I 176.8873 J -221.1092
G03 X 362.5000 Y 479.4444 I 398.6539 J -359.0339
G03 X 328.0850 Y 429.3817 I 589.1753 J -441.8815
G03 X 300.0000 Y 379.4445 I 498.5675 J -313.2635
G00 X 200.0000 Y 79.4444
G02 X 175.3270 Y 82.5253 I 0.0000 J 100.3359 F 3000.0000
G02 X 150.0000 Y 91.9444 I 30.9375 J 121.9480
G02 X 132.4961 Y 103.1785 I 43.5713 J 87.1425
G02 X 115.6250 Y 121.6319 I 51.5458 J 64.0647
G02 X 105.2395 Y 143.7147 I 68.6648 J 45.7765
G02 X 100.0000 Y 179.4444 I 119.2063 J 35.7297
G02 X 107.8395 Y 215.0476 I 84.7661 J 0.0000
G02 X 131.2500 Y 252.8819 I 167.7526 J -77.6393
G02 X 162.8650 Y 286.3998 I 221.1092 J -176.8873
G02 X 200.0000 Y 316.9444 I 359.0339 J -398.6538
G02 X 250.0627 Y 351.3594 I 441.8814 J -589.1752
G02 X 300.0000 Y 379.4445 I 313.2635 J -498.5674
G00 X0.0000 Y0.0000
S0
</div>

</div>


<div id="gcode_for_calibration" class="gcode_programs">

<a href="#">pulse near x-axis</a>
<div>
G21
G90
S80
G0X100Y100F10000
G1X105Y100F400
S0
</div>

<a href="#">pulse far x-axis</a>
<div>
G21
G90
S80
G0X100Y520F10000
G1X105Y520F400
S0
</div>

<a href="#">pulse near y-axis</a>
<div>
G21
G90
S80
G0X100Y300F10000
G1X105Y300F400
S0
</div>

<a href="#">pulse far y-axis</a>
<div>
G21
G90
S80
G0X1100Y300F10000
G1X1105Y300F400
S0
</div>

</div>

<!-- Gcode Library End -->



	
<script>


$(function() {
	$( "#tabs-main" ).tabs({
		selected: 0
	});
});


$('#log_toggle').toggle(function() {
  $("#log_content").fadeIn('slow');
	$("#log_toggle").html("hide log");
}, function() {
  $("#log_content").fadeOut('slow');
	$("#log_toggle").html("show log");
});


// connect to serial button
//	
$("#serial_connection").button();
// get serial state
$.get('/serial/2', function(data) {
	if (data != "") {
		$().uxmessage('notice', "Serial is Connected");		
		$("#serial_connection").val('1');
		$("#serial_connection").button('option', 'label', 'Disconnect');		
	} else {
		$().uxmessage('notice', "Serial is Disconnected");
		$("#serial_connection").val('0');
		$("#serial_connection").button('option', 'label', 'Connect');
	}		
});
$("#serial_connection").click(function(e){	
	if ($("#serial_connection").val() == '1') {
		$.get('/serial/0', function(data) {
			if (data != "") {
				$().uxmessage('success', "Serial Disconnected");
			} else {
				$().uxmessage('success', "Serial was already disonnected.");
			}
			$("#serial_connection").val('0');
			$("#serial_connection").button('option', 'label', 'Connect');	
		});
	}	else {
		$.get('/serial/1', function(data) {
			if (data != "") {
				$().uxmessage('success', "Serial Connected");
				$().uxmessage('notice', data);				
				$("#serial_connection").val('1');
				$("#serial_connection").button('option', 'label', 'Disconnect');
			} else {
				$().uxmessage('error', "Failed to Connect");
			}		
		});
	}	
	e.preventDefault();		
});	

//$("#find_home").button();
$("#find_home").click(function(e){
	var gcode = 'G30\n'
	$().uxmessage('notice', gcode);	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});

//$("#go_home").button();
$("#go_home").click(function(e){
	var gcode = 'G0X0Y0F20000\n'
	$().uxmessage('notice', gcode);	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});

$("#escape_fire").button();
$("#escape_fire").click(function(e){
	var gcode = 'M112X0Y0F20000\n'
	$().uxmessage('notice', gcode.replace(/\n/g, '<br>'));	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});



/////////////////////////
// laser jobs tab

$('#gcode_queue').show();

$('#library_placeholder').replaceWith($('#gcode_library'));
$('#gcode_library').show();

$('#gcode_library a').click(function(){		
	$('#gcode_program').val( $(this).next().text() );

	// make sure preview refreshes
	$('#gcode_program').trigger('blur');	
});


$('#calibration_placeholder').replaceWith($('#gcode_for_calibration'));
$('#gcode_for_calibration').show();

$('#gcode_for_calibration a').click(function(){
	$('#gcode_program').val( $(this).next().text() );

	// make sure preview refreshes
	$('#gcode_program').trigger('blur');	
});


var queue_num_index = 0;
$("#gcode_submit").button();
$("#gcode_submit").click(function(e) {
	// send gcode string to server via POST
	var gcode = $('#gcode_program').val();
	$().uxmessage('notice', gcode.replace(/\n/g, '<br>'));
	$.post("/gcode", { 'gcode_program':gcode }, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");	
			// show progress bar, register live updates
			if ($("#progressbar").progressbar( "option", "value" ) == 0) {
				$("#progressbar").progressbar( "option", "value", 5 )
				$("#progressbar").show();
			  var progresstimer = setInterval(function() {
					$.get('/queue_pct_done', function(data2) {
						//$().uxmessage('notice', data2);
						if (data2.length > 0) {
							var pct = parseInt(data2);
							//$().uxmessage('notice', data);
							$('#progressbar').progressbar( "option", "value", pct );
						} else {
							$().uxmessage('notice', "Done.");
							$('#progressbar').hide();
							$('#progressbar').progressbar( "option", "value", 0 );
							clearInterval(progresstimer);
						}
					});
			  }, 3000);
			}
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
  });

	// add gcode program to queue
	queue_num_index += 1;
	if (queue_num_index > 10) {
		// remove old items
		$('#gcode_queue').children('a').last().remove();
		$('#gcode_queue').children('div').last().remove();
	}
	var date = new Date();
	$('#gcode_queue').prepend('<a href="#">'+ date.toDateString() +' - '+ queue_num_index +'</a>\n<div>'+ gcode +'</div>\n')
	$('#gcode_queue a').click(function(){		
		$('#gcode_program').val( $(this).next().text() );

		// make sure preview refreshes
		$('#gcode_program').trigger('blur');	
	});	
	
	return false;
});



$("#progressbar").progressbar({
	value: 0
});
$("#progressbar").hide();


// G-Code Canvas Preview

var canvas = new Canvas('#preview_canvas');
var gcode = new Gcode('#gcode_program');
canvas.noStroke();
canvas.fill('ffffff');
canvas.rect(0,0,canvas.width,canvas.height);

$('#gcode_program').blur(function() {
	gcode.parse(0.25);
	gcode.draw(canvas);	
});


// laser jobs tab
/////////////////////////



/////////////////////////
// direct control tab


$("#cutting_area").click(function(e) {

	//var x = (e.pageX - this.offsetLeft);
	//var y = (e.pageY - this.offsetTop);

	var offset = $('#lasaur_widget').offset();
	var x = (e.pageX - offset.left);
	var y = (e.pageY - offset.top);
	
	var pos = $(this).position();
	var lasaur_coord_x = 4*(x - pos.left);
	var lasaur_coord_y = 4*(y - pos.top);
	// cap
	if (lasaur_coord_x > 1220) { lasaur_coord_x = 1220; }
	if (lasaur_coord_y > 620) { lasaur_coord_y = 620; }
	
	var g0_or_g1
	if($('#radio_g1').is(":checked")){
		g0_or_g1 = 'G1';
	}	else {
		g0_or_g1 = 'G0';	
	}
	var feedrate = $( "#feedrate_field" ).val();
	var gcode = g0_or_g1 + ' X' + parseInt(lasaur_coord_x) + 'Y' + parseInt(lasaur_coord_y) + 'F' + feedrate + '\n';
	
	$().uxmessage('notice', gcode);
	
	// send new pos to server, on success move graphics
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
			moveto(x, y);
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	
});

$('#move_type_radio').buttonset();
$("#feedrate").slider({ min:50, max:20000, value:$('#feedrate_field').val() });
$("#feedrate").bind( "slide", function(event, ui) {
	$('#feedrate_field').val($('#feedrate').slider("option", "value"));
});
$("#feedrate").bind( "slidestop", function(event, ui) {
	$('#feedrate_field').val($('#feedrate').slider("option", "value"));
});

$("#cutting_area").hover(
  function () {
		$(this).css('border', '1px solid #ff0000');
		$(this).css('cursor', 'crosshair');
  },
  function () {
		$(this).css('border', '1px solid #888888');
		$(this).css('cursor', 'pointer');			
  }
);	

function moveto (x, y) {
	$('#y_cart').animate({  
		top: y - 8.5 - 6
	}); 	
	
	$('#x_cart').animate({  
		left: x - 6,  
		top: y - 6 
	});
};

// direct control tab
/////////////////////////




/////////////////////////
// import tab

$('#svg_upload_form').ajaxForm({
	beforeSubmit: function() {
	  $('#svg_upload_results').html('Submitting...');
	},
	success: function(gcode) {
    $('#svg_upload_results').html('Your results:');
    $('#svg_upload_results').append('<div><pre>'+ gcode +'</pre></div>');
	
		// add gcode program to queue
		// this code is repetitive
		queue_num_index += 1;
		if (queue_num_index > 10) {
			// remove old items
			$('#gcode_queue').children('a').last().remove();
			$('#gcode_queue').children('div').last().remove();
		}
		var date = new Date();
		$('#gcode_queue').prepend('<a href="#">'+ date.toDateString() +' - '+ queue_num_index +'</a>\n<div>'+ gcode +'</div>\n')
		$('#gcode_queue a').click(function(){		
			$('#gcode_program').val( $(this).next().text() );

			// make sure preview refreshes
			$('#gcode_program').trigger('blur');	
		});		
	
  }
});


// import tab
/////////////////////////



</script>


</body>
</html>

