<!DOCTYPE html> 
<html> 
<head> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<title>LasaurApp</title> 
<link rel="stylesheet" href="/css/smoothness/jquery-ui-1.8.9.custom.css" type="text/css">	
<link rel="stylesheet" href="/css/jquery.toastmessage.css" type="text/css">	
<link rel="stylesheet" href="/css/style.css" type="text/css"> 
<script src="/js/jquery-1.5.min.js"></script>
<script src="/js/jquery-ui-1.8.9.custom.min.js"></script>
<script src="/js/jquery.toastmessage.js"></script>
<script src="/js/lasaurCanvasLib.js"></script>
<script src="/js/lasaurGcodeLib.js"></script>


</head>



<body style="min-width:930px; padding:10px">


<div id="left-panel" style="width:300px; float:left">
	
<div class="ui-corner-all" style="height:300px; background-color:#e4f83b">
	<img src="/img/lasersaur-dino-lasaurapp-190.png" style="padding:10px; padding-left:15px">
	<div id="serial_connection" class="button_row">Connect</div>
	<div id="escape_fire" class="button_row">Force Home</div>
	
	<ul style="clear:both; padding-top:20px">
	<li><a href="#" id="find_home">run homing cycle</a></li>
	<li><a href="#" id="go_home">go home to origin</a></li>
	</ul>
</div>

<div id="log-container" style="margin:5px">
<a id="log-toggle" href="#">show log</a>
<div id="log-content" style="margin-top:5px; display:none; overflow:auto; height:300px">
	<!-- log -->
</div>
</div>

</div>  <!-- end of left-panel -->


	
<div id="tabs-main" style="width:680px; height:620px; margin-left:310px;overflow:hidden;">
<ul>
	<li><a href="#tab-gcode">Laser Jobs</a></li>
	<li><a href="#tab-mover">Direct Control</a></li>
</ul>
		
<div id="tab-gcode" style="padding:30px">
	<div style="float:left">	
		<h3>From Queue</h3>
		<select id="gcode_queue_select">
		  <option value="" selected="yes">select shape</option>
		  <option value="rectangle">rectangle</option>
		  <option value="triangle">triangle</option>
		</select>
		<h3>From Library</h3>
		<div id="library_placeholder">To be replaced by Javascript</div>
	</div>	
	<div id="gcode_widget" class="ui-corner-all" style="padding:20px; background-color:#dddddd; float:right">
		<form id="gcode_form">
			<h3>G-Code</h3>
			<div><textarea id="gcode_program" style="font-size:0.8em; width:300px; height:100px"></textarea></div>
			<h3>Preview</h3>
			<div><canvas id="preview_canvas" width="305px" height="155px"></div>
			<div id="gcode_submit" style="margin-left:0; margin-top:20px">Send to Lasersaur</div>
			<div id="progressbar" style="width:305px; height:20px; margin-top:60px"></div>
		</form>	
	</div>
</div>

<div id="tab-mover" style="padding-left:128px; padding-top:60px">
		<div id="lasaur_widget" style="position:relative; width:425px; height:270px;">
			<div id="outer_top" style="position:absolute; left:10px; top:0px; width:405px; height:10px; background-color:#546883;"></div> 
			<div id="outer_left" style="position:absolute; left:0px; top:0px; width:10px; height:270px; background-color:#546883;"></div> 
			<div id="outer_right" style="position:absolute; left:415px; top:0px; width:10px; height:270px; background-color:#546883;"></div> 
			<div id="gantry_top" style="position:absolute; left:10px; top:35px; width:405px; height:10px; background-color:#83BBFF;"></div> 
			<div id="gantry_bottom" style="position:absolute; left:10px; top:260px; width:405px; height:10px; background-color:#83BBFF;"></div> 
			<div id="gantry_left" style="position:absolute; left:22.5px; top:45px; width:10px; height:215px; background-color:#83BBFF;"></div> 
			<div id="gantry_right" style="position:absolute; left:392.5px; top:45px; width:10px; height:215px; background-color:#83BBFF;"></div> 
			<div id="y_cart" style="position:absolute; left:19px; top:68px; width:387px; height:10px; background-color:#650B01;"></div> 
			<div id="x_cart" style="position:absolute; left:54px; top:76.5px; width:12px; height:12px; background-color:#9E4301;"></div> 
			<div id="cutting_area" style="position:absolute; left:60px; top:82.5px; width:305px; height:155px; border:1px solid #888888; opacity:0.3"></div>	
		</div>
		<form>
			<div id="move_type_radio" style="margin:10px; float:left">
				<input type="radio" id="radio_g0" name="radio" checked="checked" /><label for="radio_g0">G0</label>
				<input type="radio" id="radio_g1" name="radio" /><label for="radio_g1">G1</label>
			</div>
		</form>
		<div id="feedrate" style="margin:23px; width:150px; float:left"></div>
		<input id="feedrate_field" type="textfield" value="10000" style="margin:15px; width:50px; float:left"></input>
</div>

</div> <!--end of tabs -->




<!-- Gcode Library Start -->

<div id="gcode_library" style="display:none">

<a href="#">rectangle</a>	
<div>
G0X600Y400F20000
G1X630Y400F200
G1X630Y430
G1X600Y430
G1 X600Y400
G0X400Y200F20000
</div>

<a href="#">triangle</a>
<div>
G0X600Y400F20000
G1X630Y400F200
G1X630Y430
G1X600Y400
G0X400Y200F20000
</div>

<a href="#">pulse x near</a>
<div>
S90
G0X100Y100F10000
G1X105Y100F400
G0X0Y0
S0
</div>

<a href="#">pulse x far</a>
<div>
S90
G0X100Y500F10000
G1X105Y500F400
G0X0Y0
S0
</div>

<a href="#">pulse y near</a>
<div>
S90
G0X100Y300F10000
G1X105Y300F400
G0X0Y0
S0
</div>

<a href="#">pulse y far</a>
<div>
S90
G0X1000Y300F10000
G1X1005Y300F400
G0X0Y0
S0
</div>

<a href="#">curves from arcs</a>
<div>
G00 X100.000009 Y122.999980
G02 X127.753936 Y144.592104 I100.335931 J-100.335934
G02 X162.500011 Y160.499980 I91.010543 J-152.885536
G02 X191.237989 Y166.769852 I43.571275 J-130.713833
G02 X226.562515 Y165.187480 I12.518899 J-115.610519
G02 X259.030777 Y153.490227 I-22.888261 J-114.441314
G02 X300.000023 Y122.999980 I-83.476586 J-154.936095
G03 X340.969254 Y92.509724 I124.445821 J124.445751
G03 X373.437505 Y80.812469 I55.356505 J102.743966
G03 X408.762022 Y79.230097 I22.805622 J114.028057
G03 X437.499995 Y85.499971 I-14.833297 J136.983635
G03 X472.246067 Y101.407851 I-56.264472 J168.793352
G03 X499.999991 Y122.999980 I-72.582040 J121.928066
G03 X521.592115 Y150.753906 I-100.335934 J100.335934
G03 X537.499990 Y185.499979 I-152.885523 J91.010540
G03 X543.769862 Y214.237955 I-130.713817 J43.571272
G03 X542.187490 Y249.562478 I-115.610498 J12.518898
G03 X530.490238 Y282.030736 I-114.441291 J-22.888258
G03 X499.999991 Y322.999977 I-154.936068 J-83.476580
G02 X469.509744 Y363.969221 I124.445845 J124.445831
G02 X457.812491 Y396.437481 I102.744054 J55.356521
G02 X456.230119 Y431.762006 I114.028138 J22.805626
G02 X462.499991 Y460.499983 I136.983692 J-14.833296
G02 X478.407867 Y495.246057 I168.793397 J-56.264465
G02 X499.999991 Y522.999982 I121.928049 J-72.582003
</div>

</div>

<!-- Gcode Library End -->



	
<script>

(function($){  
	 $.fn.uxmessage = function(kind, text) {
		if (kind == 'notice') {
			$('#log-content').prepend('NOTICE: ' + text + '<br>');
			$().toastmessage('showNoticeToast', text);
		} else if (kind == 'success') {
			$('#log-content').prepend('SUCESS: ' + text + '<br>');
			$().toastmessage('showSuccessToast', text);		
		} else if (kind == 'warning') {
			$('#log-content').prepend('WARNING: ' + text + '<br>');
			$().toastmessage('showWarningToast', text);		
		} else if (kind == 'error') {
			$('#log-content').prepend('ERROR: ' + text + '<br>');
			$().toastmessage('showErrorToast', text);		
		}
	};
})(jQuery); 
// TODO: limit log buffer size



$(function() {
	$( "#tabs-main" ).tabs({
		selected: 0
	});
});


$('#log-toggle').toggle(function() {
  $("#log-content").fadeIn('slow');
	$("#log-toggle").html("hide log");
}, function() {
  $("#log-content").fadeOut('slow');
	$("#log-toggle").html("show log");
});


// connect to serial button
//	
$("#serial_connection").button();
// get serial state
$.get('/serial/2', function(data) {
	if (data != "") {
		$().uxmessage('notice', "Serial is Connected");		
		$("#serial_connection").val('1');
		$("#serial_connection").button('option', 'label', 'Disconnect');		
	} else {
		$().uxmessage('notice', "Serial is Disconnected");
		$("#serial_connection").val('0');
		$("#serial_connection").button('option', 'label', 'Connect');
	}		
});
$("#serial_connection").click(function(e){	
	if ($("#serial_connection").val() == '1') {
		$.get('/serial/0', function(data) {
			if (data != "") {
				$().uxmessage('success', "Serial Disconnected");
			} else {
				$().uxmessage('success', "Serial was already disonnected.");
			}
			$("#serial_connection").val('0');
			$("#serial_connection").button('option', 'label', 'Connect');	
		});
	}	else {
		$.get('/serial/1', function(data) {
			if (data != "") {
				$().uxmessage('success', "Serial Connected");
				$().uxmessage('notice', data);				
				$("#serial_connection").val('1');
				$("#serial_connection").button('option', 'label', 'Disconnect');
			} else {
				$().uxmessage('error', "Failed to Connect");
			}		
		});
	}	
	e.preventDefault();		
});	

//$("#find_home").button();
$("#find_home").click(function(e){
	var gcode = 'G30\n'
	$().uxmessage('notice', gcode);	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});

//$("#go_home").button();
$("#go_home").click(function(e){
	var gcode = 'G0X0Y0F20000\n'
	$().uxmessage('notice', gcode);	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});

$("#escape_fire").button();
$("#escape_fire").click(function(e){
	var gcode = 'M112X0Y0F20000\n'
	$().uxmessage('notice', gcode.replace(/\n/g, '<br>'));	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});



/////////////////////////
// laser jobs tab

var gcode_list_html = '<ul>';
$('#gcode_library').children().each(function() {
	gcode_list_html += '<li>'+ $(this).children('div').text() +'</li>';
});
gcode_list_html += '</ul>';

$('#library_placeholder').replaceWith($('#gcode_library'));
$('#gcode_library').show();

$('#gcode_library a').click(function(){
	$('#gcode_program').val( $(this).next().text() );

	// make sure preview refreshes
	$('#gcode_program').trigger('blur');	
});




$("#gcode_submit").button();
$("#gcode_submit").click(function(e) {
	// send gcode string to server via POST
	var gcode = $('#gcode_program').val();
	$().uxmessage('notice', gcode.replace(/\n/g, '<br>'));
	$.post("/gcode", { 'gcode_program':gcode }, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");	
			// show progress bar, register live updates
			if ($("#progressbar").progressbar( "option", "value" ) == 0) {
				$("#progressbar").progressbar( "option", "value", 5 )
				$("#progressbar").show();
			  var progresstimer = setInterval(function() {
					$.get('/queue_pct_done', function(data2) {
						//$().uxmessage('notice', data2);
						if (data2.length > 0) {
							var pct = parseInt(data2);
							//$().uxmessage('notice', data);
							$('#progressbar').progressbar( "option", "value", pct );
						} else {
							$().uxmessage('notice', "Done.");
							$('#progressbar').hide();
							$('#progressbar').progressbar( "option", "value", 0 );
							clearInterval(progresstimer);
						}
					});
			  }, 3000);
			}
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
  });		
	return false;
});
$("#gcode_program").keyup(function(e) {
	$('#gcode_select').val('select shape');
});
$("#progressbar").progressbar({
	value: 0
});
$("#progressbar").hide();


// end laser jobs tab
/////////////////////////



/////////////////////////
// lasaur widget


$("#cutting_area").click(function(e) {

	//var x = (e.pageX - this.offsetLeft);
	//var y = (e.pageY - this.offsetTop);

	var offset = $('#lasaur_widget').offset();
	var x = (e.pageX - offset.left);
	var y = (e.pageY - offset.top);
	
	var pos = $(this).position();
	var lasaur_coord_x = 4*(x - pos.left);
	var lasaur_coord_y = 4*(y - pos.top);
	// cap
	if (lasaur_coord_x > 1220) { lasaur_coord_x = 1220; }
	if (lasaur_coord_y > 620) { lasaur_coord_y = 620; }
	
	var g0_or_g1
	if($('#radio_g1').is(":checked")){
		g0_or_g1 = 'G1';
	}	else {
		g0_or_g1 = 'G0';	
	}
	var feedrate = $( "#feedrate_field" ).val();
	var gcode = g0_or_g1 + ' X' + parseInt(lasaur_coord_x) + 'Y' + parseInt(lasaur_coord_y) + 'F' + feedrate + '\n';
	
	$().uxmessage('notice', gcode);
	
	// send new pos to server, on success move graphics
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
			moveto(x, y);
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	
});

$('#move_type_radio').buttonset();
$("#feedrate").slider({ min:50, max:20000, value:$('#feedrate_field').val() });
$("#feedrate").bind( "slide", function(event, ui) {
	$('#feedrate_field').val($('#feedrate').slider("option", "value"));
});
$("#feedrate").bind( "slidestop", function(event, ui) {
	$('#feedrate_field').val($('#feedrate').slider("option", "value"));
});

$("#cutting_area").hover(
  function () {
		$(this).css('border', '1px solid #ff0000');
		$(this).css('cursor', 'crosshair');
  },
  function () {
		$(this).css('border', '1px solid #888888');
		$(this).css('cursor', 'pointer');			
  }
);	

function moveto (x, y) {
	$('#y_cart').animate({  
		top: y - 8.5 - 6
	}); 	
	
	$('#x_cart').animate({  
		left: x - 6,  
		top: y - 6 
	});
};

// end lasaur widget
/////////////////////////




/////////////////////////
// G-Code Canvas Preview


var canvas = new Canvas('#preview_canvas');
var gcode = new Gcode('#gcode_program');
canvas.noStroke();
canvas.fill('ffffff');
canvas.rect(0,0,canvas.width,canvas.height);

$('#gcode_program').blur(function() {
	gcode.parse(0.25);
	gcode.draw(canvas);	
});

//
/////////////////////////

</script>


</body>
</html>

