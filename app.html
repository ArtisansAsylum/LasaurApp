<!DOCTYPE html> 
<html> 
<head> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<title>LasaurApp</title> 
<link rel="stylesheet" href="/css/smoothness/jquery-ui-1.8.9.custom.css" type="text/css">	
<link rel="stylesheet" href="/css/jquery.toastmessage.css" type="text/css">	
<link rel="stylesheet" href="/css/style.css" type="text/css"> 
<script src="/js/jquery-1.5.min.js"></script>
<script src="/js/jquery-ui-1.8.9.custom.min.js"></script>
<script src="/js/jquery.toastmessage.js"></script>
<script src="/js/lasaurCanvasLib.js"></script>
<script src="/js/lasaurGcodeLib.js"></script>


</head>



<body style="min-width:930px; padding:10px">


<div id="left-panel" style="width:300px; float:left">
	
<div class="ui-corner-all" style="height:300px; background-color:#e4f83b">
	<img src="/img/lasersaur-dino-lasaurapp-190.png" style="padding:10px; padding-left:15px">
	<div id="serial_connection" class="button_row">Connect</div>
	<div id="escape_fire" class="button_row">Force Home</div>
	
	<ul style="clear:both; padding-top:20px">
	<li><a href="#" id="find_home">run homing cycle</a></li>
	<li><a href="#" id="go_home">go home to origin</a></li>
	</ul>
</div>

<div id="log-container" style="margin:5px">
<a id="log-toggle" href="#">show log</a>
<div id="log-content" style="margin-top:5px; display:none; overflow:auto; height:300px">
	<!-- log -->
</div>
</div>

</div>  <!-- end of left-panel -->


	
<div id="tabs-main" style="width:680px; height:620px; margin-left:310px;overflow:hidden;">
<ul>
	<li><a href="#tab-gcode">Laser Jobs</a></li>
	<li><a href="#tab-mover">Direct Control</a></li>
</ul>
		
<div id="tab-gcode" style="padding:30px">
	<div style="float:left">	
		<h3>From Queue</h3>
		<select id="gcode_select">
		  <option value="" selected="yes">select shape</option>
		  <option value="rectangle">rectangle</option>
		  <option value="triangle">triangle</option>
		  <option value="pulse_x1">pulse x near</option>
		  <option value="pulse_x2">pulse x far</option>
		  <option value="pulse_y1">pulse y near</option>
		  <option value="pulse_y2">pulse y far</option>
		</select>
		<h3>From Library</h3>
		<select id="gcode_select">
		  <option value="" selected="yes">select shape</option>
		  <option value="rectangle">rectangle</option>
		  <option value="triangle">triangle</option>
		  <option value="pulse_x1">pulse x near</option>
		  <option value="pulse_x2">pulse x far</option>
		  <option value="pulse_y1">pulse y near</option>
		  <option value="pulse_y2">pulse y far</option>
		</select>
	</div>	
	<div id="gcode_widget" class="ui-corner-all" style="padding:20px; background-color:#dddddd; float:right">
		<form id="gcode_form">
			<h3>G-Code</h3>
			<div><textarea id="gcode_program" style="font-size:0.8em; width:300px; height:100px"></textarea></div>
			<h3>Preview</h3>
			<div><canvas id="preview_canvas" width="305px" height="155px"></div>
			<div id="gcode_submit" style="margin-left:0; margin-top:20px">Send to Lasersaur</div>
			<div id="progressbar" style="width:305px; height:20px; margin-top:60px"></div>
		</form>	
	</div>
</div>

<div id="tab-mover" style="padding-left:128px; padding-top:60px">
		<div id="lasaur_widget" style="position:relative; width:425px; height:270px;">
			<div id="outer_top" style="position:absolute; left:10px; top:0px; width:405px; height:10px; background-color:#546883;"></div> 
			<div id="outer_left" style="position:absolute; left:0px; top:0px; width:10px; height:270px; background-color:#546883;"></div> 
			<div id="outer_right" style="position:absolute; left:415px; top:0px; width:10px; height:270px; background-color:#546883;"></div> 
			<div id="gantry_top" style="position:absolute; left:10px; top:35px; width:405px; height:10px; background-color:#83BBFF;"></div> 
			<div id="gantry_bottom" style="position:absolute; left:10px; top:260px; width:405px; height:10px; background-color:#83BBFF;"></div> 
			<div id="gantry_left" style="position:absolute; left:22.5px; top:45px; width:10px; height:215px; background-color:#83BBFF;"></div> 
			<div id="gantry_right" style="position:absolute; left:392.5px; top:45px; width:10px; height:215px; background-color:#83BBFF;"></div> 
			<div id="y_cart" style="position:absolute; left:19px; top:68px; width:387px; height:10px; background-color:#650B01;"></div> 
			<div id="x_cart" style="position:absolute; left:54px; top:76.5px; width:12px; height:12px; background-color:#9E4301;"></div> 
			<div id="cutting_area" style="position:absolute; left:60px; top:82.5px; width:305px; height:155px; border:1px solid #888888; opacity:0.3"></div>	
		</div>
		<form>
			<div id="move_type_radio" style="margin:10px; float:left">
				<input type="radio" id="radio_g0" name="radio" checked="checked" /><label for="radio_g0">G0</label>
				<input type="radio" id="radio_g1" name="radio" /><label for="radio_g1">G1</label>
			</div>
		</form>
		<div id="feedrate" style="margin:23px; width:150px; float:left"></div>
		<input id="feedrate_field" type="textfield" value="10000" style="margin:15px; width:50px; float:left"></input>
</div>

</div> <!--end of tabs -->




	
<script>

(function($){  
	 $.fn.uxmessage = function(kind, text) {
		if (kind == 'notice') {
			$('#log-content').prepend('NOTICE: ' + text + '<br>');
			$().toastmessage('showNoticeToast', text);
		} else if (kind == 'success') {
			$('#log-content').prepend('SUCESS: ' + text + '<br>');
			$().toastmessage('showSuccessToast', text);		
		} else if (kind == 'warning') {
			$('#log-content').prepend('WARNING: ' + text + '<br>');
			$().toastmessage('showWarningToast', text);		
		} else if (kind == 'error') {
			$('#log-content').prepend('ERROR: ' + text + '<br>');
			$().toastmessage('showErrorToast', text);		
		}
	};
})(jQuery); 
// TODO: limit log buffer size



$(function() {
	$( "#tabs-main" ).tabs({
		selected: 0
	});
});


$('#log-toggle').toggle(function() {
  $("#log-content").fadeIn('slow');
	$("#log-toggle").html("hide log");
}, function() {
  $("#log-content").fadeOut('slow');
	$("#log-toggle").html("show log");
});


// connect to serial button
//	
$("#serial_connection").button();
// get serial state
$.get('/serial/2', function(data) {
	if (data != "") {
		$().uxmessage('notice', "Serial is Connected");		
		$("#serial_connection").val('1');
		$("#serial_connection").button('option', 'label', 'Disconnect');		
	} else {
		$().uxmessage('notice', "Serial is Disconnected");
		$("#serial_connection").val('0');
		$("#serial_connection").button('option', 'label', 'Connect');
	}		
});
$("#serial_connection").click(function(e){	
	if ($("#serial_connection").val() == '1') {
		$.get('/serial/0', function(data) {
			if (data != "") {
				$().uxmessage('success', "Serial Disconnected");
			} else {
				$().uxmessage('success', "Serial was already disonnected.");
			}
			$("#serial_connection").val('0');
			$("#serial_connection").button('option', 'label', 'Connect');	
		});
	}	else {
		$.get('/serial/1', function(data) {
			if (data != "") {
				$().uxmessage('success', "Serial Connected");
				$().uxmessage('notice', data);				
				$("#serial_connection").val('1');
				$("#serial_connection").button('option', 'label', 'Disconnect');
			} else {
				$().uxmessage('error', "Failed to Connect");
			}		
		});
	}	
	e.preventDefault();		
});	

//$("#find_home").button();
$("#find_home").click(function(e){
	var gcode = 'G30\n'
	$().uxmessage('notice', gcode);	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});

//$("#go_home").button();
$("#go_home").click(function(e){
	var gcode = 'G0X0Y0F20000\n'
	$().uxmessage('notice', gcode);	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});

$("#escape_fire").button();
$("#escape_fire").click(function(e){
	var gcode = 'M112X0Y0F20000\n'
	$().uxmessage('notice', gcode.replace(/\n/g, '<br>'));	
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	e.preventDefault();		
});


// gcode widget
//

$('#gcode_select').change(function() {
	
	if ($(this).val() == "rectangle") {
		var gcode = 'G0X600Y400F20000\n'
		gcode += 'G1X630Y400F200\n'
		gcode += 'G1X630Y430\n'
		gcode += 'G1X600Y430\n'
		gcode += 'G1 X600Y400\n'
		gcode += 'G0X400Y200F20000\n'
		$('#gcode_program').val(gcode);
	} else if ($(this).val() == "triangle"){
		var gcode = 'G0X600Y400F20000\n'
		gcode += 'G1X630Y400F200\n'
		gcode += 'G1X630Y430\n'
		gcode += 'G1X600Y400\n'
		gcode += 'G0X400Y200F20000\n'
		$('#gcode_program').val(gcode);		
	} else if ($(this).val() == "pulse_x1"){
		var gcode = 'S90\n' 
		gcode += 'G0X100Y100F10000\n'
		gcode += 'G1X105Y100F400\n'
		gcode += 'G0X0Y0\n'
		gcode += 'S0\n'
		$('#gcode_program').val(gcode);		
	} else if ($(this).val() == "pulse_x2"){
		var gcode = 'S90\n' 
		gcode += 'G0X100Y500F10000\n'
		gcode += 'G1X105Y500F400\n'
		gcode += 'G0X0Y0\n'
		gcode += 'S0\n'
		$('#gcode_program').val(gcode);		
	} else if ($(this).val() == "pulse_y1"){
		var gcode = 'S90\n' 
		gcode += 'G0X100Y300F10000\n'
		gcode += 'G1X105Y300F400\n'
		gcode += 'G0X0Y0\n'
		gcode += 'S0\n'
		$('#gcode_program').val(gcode);		
	} else if ($(this).val() == "pulse_y2"){
		var gcode = 'S90\n' 
		gcode += 'G0X1000Y300F10000\n'
		gcode += 'G1X1005Y300F400\n'
		gcode += 'G0X0Y0\n'
		gcode += 'S0\n'
		$('#gcode_program').val(gcode);		
	}
	
	// make sure preview refreshes
	$('#gcode_program').trigger('blur');
	
});

$("#gcode_submit").button();
$("#gcode_submit").click(function(e) {
	// send gcode string to server via POST
	var gcode = $('#gcode_program').val();
	$().uxmessage('notice', gcode.replace(/\n/g, '<br>'));
	$.post("/gcode", { 'gcode_program':gcode }, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");	
			// show progress bar, register live updates
			if ($("#progressbar").progressbar( "option", "value" ) == 0) {
				$("#progressbar").progressbar( "option", "value", 5 )
				$("#progressbar").show();
			  var progresstimer = setInterval(function() {
					$.get('/queue_pct_done', function(data2) {
						//$().uxmessage('notice', data2);
						if (data2.length > 0) {
							var pct = parseInt(data2);
							//$().uxmessage('notice', data);
							$('#progressbar').progressbar( "option", "value", pct );
						} else {
							$().uxmessage('notice', "Done.");
							$('#progressbar').hide();
							$('#progressbar').progressbar( "option", "value", 0 );
							clearInterval(progresstimer);
						}
					});
			  }, 3000);
			}
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
  });		
	return false;
});
$("#gcode_program").keyup(function(e) {
	$('#gcode_select').val('select shape');
});
$("#progressbar").progressbar({
	value: 0
});
$("#progressbar").hide();

// lasaur widget
//

$("#cutting_area").click(function(e) {

	//var x = (e.pageX - this.offsetLeft);
	//var y = (e.pageY - this.offsetTop);

	var offset = $('#lasaur_widget').offset();
	var x = (e.pageX - offset.left);
	var y = (e.pageY - offset.top);
	
	var pos = $(this).position();
	var lasaur_coord_x = 4*(x - pos.left);
	var lasaur_coord_y = 4*(y - pos.top);
	// cap
	if (lasaur_coord_x > 1220) { lasaur_coord_x = 1220; }
	if (lasaur_coord_y > 620) { lasaur_coord_y = 620; }
	
	var g0_or_g1
	if($('#radio_g1').is(":checked")){
		g0_or_g1 = 'G1';
	}	else {
		g0_or_g1 = 'G0';	
	}
	var feedrate = $( "#feedrate_field" ).val();
	var gcode = g0_or_g1 + ' X' + parseInt(lasaur_coord_x) + 'Y' + parseInt(lasaur_coord_y) + 'F' + feedrate + '\n';
	
	$().uxmessage('notice', gcode);
	
	// send new pos to server, on success move graphics
	$.get('/gcode/'+ gcode, function(data) {
		if (data != "") {
			$().uxmessage('success', "G-Code sent to serial.");
			moveto(x, y);
		} else {
			$().uxmessage('error', "Serial not connected.");
		}
	});
	
});

$('#move_type_radio').buttonset();
$("#feedrate").slider({ min:50, max:20000, value:$('#feedrate_field').val() });
$("#feedrate").bind( "slide", function(event, ui) {
	$('#feedrate_field').val($('#feedrate').slider("option", "value"));
});
$("#feedrate").bind( "slidestop", function(event, ui) {
	$('#feedrate_field').val($('#feedrate').slider("option", "value"));
});

$("#cutting_area").hover(
  function () {
		$(this).css('border', '1px solid #ff0000');
		$(this).css('cursor', 'crosshair');
  },
  function () {
		$(this).css('border', '1px solid #888888');
		$(this).css('cursor', 'pointer');			
  }
);	

function moveto (x, y) {
	$('#y_cart').animate({  
		top: y - 8.5 - 6
	}); 	
	
	$('#x_cart').animate({  
		left: x - 6,  
		top: y - 6 
	});
};




/////////////////////////
// G-Code Canvas Preview


var canvas = new Canvas('#preview_canvas');
var gcode = new Gcode('#gcode_program');
canvas.noStroke();
canvas.fill('ffffff');
canvas.rect(0,0,canvas.width,canvas.height);

$('#gcode_program').blur(function() {
	gcode.parse(0.25);
	gcode.draw(canvas);	
});

//
/////////////////////////

</script>


</body>
</html>

